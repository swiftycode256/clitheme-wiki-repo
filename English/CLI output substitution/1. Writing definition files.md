# Writing definition files: CLI output substitution

CLItheme allows you to customize the output of any command-line application through substitution rules. This article details how to write substitution rules in a [theme definition file](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/File%20format%20and%20syntax.md).

## Writing the `header` section

First, you need to define some basic information about the theme and file, such as name and description. Please see the [header section](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/header%20section.md) article.

## Defining substitution rules

In a theme definition file, all output substitution rules are defined in the `substrules` section:

```plaintext
{substrules}
    # <Define rules here>
{/substrules}
```

There are two types of substitution rules: **string substitution**, which matches equivalent text and characters, and **regex substitution**, which matches text by regular expressions.

### String and regex substitution：`subst_string` and `subst_regex`

This is the syntax for defining substitution rules:

```plaintext
{substrules}
    # `substesc` replaces {{ESC}} with ASCII Escape
    (set_options) substesc

    [subst_string] <Single-line match string>
    # Or:
    [subst_string>>
        <Multi-line match string>
    <<subst_string]
        [locale] <Locale or `default`>
            <Substitution string>
        [/locale]
        # Or:
        locale[<Locale or `default`>]: <Substitution string>
    [/subst_string]

    [subst_regex] <Single-line regex pattern>
    # Or:
    [subst_regex>>
        <Multi-line regex pattern>
    <<subst_regex]
        [locale] <Locale or default>
            <Substitution pattern>
        [/locale]
        # Or:
        locale[<Locale or default>]: <Substitution pattern>
    [/subst_regex]
{/substrules}
```

---

- **Single-line match**: Place the string to match after the `[subst_string]` clause; Place the regex pattern after the `[subst_regex]` clause
    - It can only match single-line output. For example, `content(\r\n)content` won't match and needs a multi-line match rule.
- **Multi-line match**: Place the string/regex pattern in the `[subst_string>>` or `[subst_regex>>` clause, terminating with `<<subst_string]` or `<<subst_regex]`
    - It's recommended to use newlines in the content block for matching newline characters in output, since **newlines in match expression will match different types of newline characters**.
    - If you want to use `\r` or `\n` in regex match patterns, verify the actual newline character used in the output with `clitheme-exec --showchars <command>`
    - Indents in the content block are processed by how multi-line content blocks work; please see [Multi-line content block](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Multi-line%20content%20block.md) for more information.
- CLItheme uses the Python's built-in regex engine, meaning that regex patterns use Python's regex syntax. Please see [this article](https://docs.python.org/zh-cn/3/howto/regex.html) for more information.

---

**Single-line substitution:**

- If there is only one line in the substitute content, you can use `locale[<Locale>]:` syntax and add the content after this clause. The rule will be active only if the current system locale matches the defined locale.
    - You can define multiple locales, such as `locale[en_US C]:`
    - For more information on locale support, please see the [Locale support](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Locale%20support.md) article
- If you don't need to restrict to a specific locale, you can use the `default:` syntax (equivalent to `locale[default]:`)
    - It acts as a "fallback" option: it will be used when other locale definitions don't match the system locale

**Multi-line substitution:**

- Input the substitute content in the `[locale]` content block, and add locale names after this clause. 
    - You can define multiple locales, such as `[locale] en_US C`
    - For more information on locale support, please see the [Locale support](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Locale%20support.md) article
    - Indents in the content block are processed by how multi-line content blocks work; please see [Multi-line content block](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Multi-line%20content%20block.md) for more information.
- If you don't need to restrict to a specific locale, you can use the `[default]` syntax (equivalent to `[locale] default`)
    - It acts as a "fallback" option: it will be used when other locale definitions don't match the system locale

---

- **If the output contains any terminal control sequences, they must be included in the match expression.** You can use the `clitheme-exec --showchars` command to see these control characters in green color. (see [Using clitheme-exec](2.%20Using%20clitheme-exec.md) for more information)
    - To use the ANSI Escape character (`{{ESC}}`), please [enable](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Available%20options.md) the `substesc` option and use `{{ESC}}` in content
    - To use other characters like `\x08` or `\x07`, please [enable](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Available%20options.md) the `substchar` option and use phrases like `{{[x08]}}` in content

> [!TIP]
> Please see [Available options](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Available%20options.md) for more options and features like content variables, matching cursor position sequences with newlines, matching only if process is foreground.

- Substitution rules are applied in the order which they are defined in the file; if there are multiple files, the theme/file ordering is used
    - This means that you can modify the same line of output through multiple substitution rules, but content replaced previously needs to be considered
- If the match pattern, command filter, ~~and stdout/stderr filter~~ of a rule is the same as a previous rule, the old rule will be deleted
- If the time for applying substitution rules exceeds 1 second, a timeout occurs and the output will not be modified
- You don't need to match all content in a line; you can match and replace only a portion of the line content

### Example

```plaintext
{substrules}
    # `substesc` and `endmatchhere` is set for the following rules
    (set_options) endmatchhere substesc
    [subst_string] Some text
        [default]
            Some other text here
            Good stuff {{ESC}}
        [/default]
    [/subst_string] subststderronly
    [subst_string] Some other text
        # Effective only if system locale is en_US
        [locale] en_US
            Another good stuff
        [/locale]
    [/subst_string] noendmatchhere subststdoutonly
    # The above `noendmatchhere` overrides previously defined `endmatchhere`
    [subst_regex] Error at file number (?P<num>\d+): item (?P<name>.+) not found
        # If system locale is zh_CN, the following definition is used:
        locale[zh_CN]: (ToT)/~~~ 在文件\g<num>发生错误：找不到项目"\g<name>"！(>﹏<)
        # Else, the following definition is used:
        default: (ToT)/~~~ Error at file number \g<num>! Could not find item "\g<name>"!
    [/subst_regex]
{/substrules}
```

### Defining multiple match content at once

When the substitute content is the same, you can define multiple match contents for a rule definition. This eliminates the needs for copying and pasting the same definitions.

> [!NOTE]
> You can't define `[subst_string]` and `[subst_regex]` at the same time (can't mix two types of substitution rules together)

```plaintext
{substrules}
    [subst_string] Some text 1
    [subst_string] Some another text
    [subst_string>>
        Multi-line text
    <<subst_string]
        default: Some substitution text
    [/subst_string]
    # Equivalent to the following:
    [subst_string] Some text 1
        default: Some substitution text
    [/subst_string]
    [subst_string] Some another text
        default: Some substitution text
    [/subst_string]
    [subst_string>>
        Multi-line text
    <<subst_string]
        default: Some substitution text
    [/subst_string]

    # Can't be mixed together:
    # [subst_string] Some text 1
    # [subst_regex] Some regex 1
    #     default: Some substitution text
    # [/subst_string]
{/substrules}
```

## Applying command filter onto substitution rules

To prevent a substitution rule from being accidentally applied onto an unrelated application, you can apply command filters onto substitution rules.

```plaintext
{substrules}
    [filter_cmds]
        <Commands separated by newlines>
    [/filter_cmds]
    # You can also use this syntax:
    <filter_cmd> <Command>

    # Regex
    [filter_cmds_regex]
        <Regex patterns separated by newlines>
    [/filter_cmds_regex]
    # You can also use this syntax:
    <filter_cmd_regex> <Command>

    # Command filter will be effective for following rules:
    [subst_regex]
        <...>
    [/subst_regex]

    # Remove the filter for following rules:
    <unset_filter_cmd>

    # This rule will not have a command filter
    [subst_regex]
        <...>
    [/subst_regex]
{/substrules}
```

- Input commands separated by newlines in the `[filter_cmds]` block. Afterwards, following substitution rules will only apply if the commands match.
    - You can specify commands with options, such as `rm -r -f`
- You can also use `<filter_cmd> <Command>` to specify a single command
- You can also use `[filter_cmds_regex]` or `<filter_cmd_regex>` to match commands using regex patterns. It will attempt to match the start of the command (same as adding `^` at start of expression).
- Use `<unset_filter_cmd>` to remove the command filter for following substitution rules

> [!NOTE]
> If the first phrase of the command user entered contains a path, CLItheme will also check its base name. For example, if the user entered `/usr/bin/python3 test.py` or `python3.exe test.py`, it will also check for `python3 test.py`.

### Command matching mechanism

By default, if the first phrase of the command matches and the command includes all phrases defined in the command filter, the relevant substitution rules will be applied.

For example, the command `rm something -rf` will match the command filter `rm -rf`, but will not match `something -rf rm` (different first phrase) and `rm -f` (command doesn't include `-f`)

You can choose [other matching mechanisms](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Available%20options.md) by [setting options](../[Appendix]%20Common%20syntax%20of%20theme%20definition%20files/Available%20options.md) for command filters, such as:

```plaintext
[filter_cmds]
    example-app some-opt
    another-app some-arg
[/filter_cmds] strictcmdmatch
```

```plaintext
(set_options) linebounds
<filter_cmd> |example-app some-opt| strictcmdmatch
```

## Apply the theme (`clitheme apply-theme`)

After writing the theme definition file, use `clitheme apply-theme <filename>` to apply the theme, and use `clitheme-exec` to use the substitution rules. Please see [Using clitheme-exec](2.%20Using%20clitheme-exec.md) for more information.